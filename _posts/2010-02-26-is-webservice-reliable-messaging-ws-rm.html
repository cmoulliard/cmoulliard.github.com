---
layout: post
title: "Is Webservice Reliable Messaging (WS-RM) the ugly duck of the WS-* story ?"
date: 2010-02-26
comments: false
---

<div class='post'>
The Webservice Reliable Messaging (WS-RM) specification has been designed a couple of years ago (2005) but few projects used it. Different reasons could explain this situation, the complexity of the specification, the cost to implement it and the lack of use cases. Personally, I think that developers and architects adopt a low profile when designing a solution and spend times developing alternative solutions providing functionality similar to what WS-RM propose.<br /><br />WS-RM is not a the ugly duck of the story and need more attention from community because it allows you to design solutions where you will be able to<br />- Guaranty of message (= web services) delivery required by example in financial order processing, alarm monitoring systems, ...<br />- Control the communication between the client and the server (retransmission, ...)<br />- Implement asynchronous solution by decoupling the request from the reply<br /><br />Well, what I have presented could be assimilated to a style exercise or a faith act and you will adhere or not. To convince you about the interests to use WS-RM, I will show you How easy it is to design such a solution using Apache CXF framework. This process can be achieved in three simple steps<br /><br /><ul><li>A. Turn on your WSDL contract into a WS-addressing</li></ul><br />WS-addressing needs to be used because the communication between the client and server will be governed by the Reliable Message Server which is running on a different<br />port address number. This decoupling is required to allow to retransmit message, acknowledge the messages received and guaranty the delivery<br /><br />Here is one way that you can adopt :<br /><br /><pre name="code" class="xml"><br />  <!-- Service definition --><br />  <wsdl:service name="ReportIncidentEndpointService"><br />      <wsdl:port name="ReportIncidentPort" binding="tns:ReportIncidentBinding"><br />          <soap:address location="http://localhost:8080/cxf/camel-example/incident"><br />          <!-- <wswa:usingaddressing wswa="http://www.w3.org/2005/02/addressing/wsdl"> --><br />          <wswa:usingaddressing wswa="http://www.w3.org/2005/02/addressing/wsdl"><br />      </wswa:usingaddressing><br />  </soap:address><br /></wsdl:port></wsdl:service></pre><br /><br />the other consists in to use a Policy Rule (= WS-Policy)<br /><br /><pre name="code" class="xml"><br />  <wsp:policy wsp="http://www.w3.org/2006/07/ws-policy"><br />    <wsam:addressing wsam="http://www.w3.org/2007/02/addressing/metadata"><br />      <wsp:policy><br />    </wsp:policy><br />  </wsam:addressing><br /></wsp:policy></pre><br /><br /><ul><li style="">B. Activate the Reliable Server </li></ul><br />Now that the WSDL contract is modified, we need to add the Reliable Server to the configuration of our platform. I will show you using a spring xml configuration file<br />but you can use the Apache CXF classes in your java code if you want<br /><br />To activate the RM server, you simply needs to add the tags wsa:addressing and wsrm-mgr in the bus definition of Apache CXF. Different parameters are available like<br />retransmission interval, acknowledge interval. I will not digg into these ones and if you need information, I invite you to check Apache CXF javadoc and specifications. By example<br />ikt is possible to activate also the persistence manager of the RM server ;-)<br /><br /><pre name="code" class="xml"><br />  <cxf:bus><br />      <cxf:features><br />          <cxf:logging><br />          <wsa:addressing><br />          <wsrm-mgr:reliablemessaging><br />              <wsrm-policy:rmassertion><br />                  <wsrm-policy:baseretransmissioninterval milliseconds="4000"><br />                  <wsrm-policy:acknowledgementinterval milliseconds="2000"><br />              </wsrm-policy:acknowledgementinterval><br />              <wsrm-mgr:destinationpolicy><br />                  <wsrm-mgr:ackspolicy intramessagethreshold="0"><br />              </wsrm-mgr:ackspolicy><br />          </wsrm-mgr:destinationpolicy><br />      </wsrm-policy:baseretransmissioninterval><br />  </wsrm-policy:rmassertion><br /></wsrm-mgr:reliablemessaging></wsa:addressing></cxf:logging></cxf:features></cxf:bus></pre><br /><br />If you use CXF in combination with the Routing engine Apache Camel, you don't need to do additional things as the Apache CXF endpoint who will consume the web servicesmessages<br />will be drived by the RM server of CXF.<br /><br />Here is an example of Camel integration with CXF<br /><br /><pre name="code" class="xml"><br />  <!-- webservice endpoint --><br />  <cxfcamel:cxfendpoint id="reportIncident" address="http://localhost:8080/cxf/camel-example/incident" serviceclass="org.apache.camel.example.reportincident.ReportIncidentEndpoint" s="http://reportincident.example.camel.apache.org"><br />  </cxfcamel:cxfendpoint><br /><br />  <!-- Camel route --><br />  <camel:camelcontext trace="true" xmlns="http://camel.apache.org/schema/osgi"><br />      <camel:route><br />          <camel:from uri="cxf:bean:reportIncident"> // messages are consumed from CXF endpoint<br />          <camel:convertbodyto type="org.apache.camel.example.reportincident.InputReportIncident"> // the body of the WS message is converted directly into a POJOI<br />          <camel:to uri="bean:webservice"> // We call a POJO to save the reportincident in a DB<br />          <camel:inOnly uri="osgiqueuingservice:queue:in"> // We put the object in a queue<br />          <camel:transform><br />              <camel:method bean="feedback" method="setOk"> // We provide a feedback message as the WS is of type request/replyt<br />          </camel:method><br /><br />      </camel:transform><br />  </camel:to><br /></camel:to></camel:convertbodyto></camel:from></camel:route></camel:camelcontext></pre><br /><br /><ul><li>C. Verify</li></ul><br />If you use a java client using Apache CXF java classes, you can easily enable the logging of the IN/OUT WS messages exchanged with the RM server and the application.<br />The following trace shows that :<br />- a sequence has been started<br />- each message is identified '' with a UID<br />- Within a sequence, the messages send receive a messageID<br />- The server acknowledge the reception (= processing) of the messages<br /><br /><textarea cols="80" rows="20"><br /><br />>>>> Invoking reportIncident ... for accident : 0<br />24-fÚvr.-2010 9:48:39 org.apache.cxf.transport.http.HTTPConduit setUpDecoupledDestination<br />INFO: creating decoupled endpoint: http://localhost:9999/camel-example/incident<br />2010-02-24 09:48:39.796::INFO:  Logging to STDERR via org.mortbay.log.StdErrLog<br />2010-02-24 09:48:39.828::INFO:  jetty-6.1.21<br />2010-02-24 09:48:39.921::INFO:  Started SelectChannelConnector@localhost:9999<br />24-fÚvr.-2010 9:48:40 org.apache.cxf.ws.rm.Proxy invoke<br />INFO: Sending out-of-band RM protocol message {http://schemas.xmlsoap.org/ws/2005/02/rm}CreateSequence.<br />24-fÚvr.-2010 9:48:41 org.apache.cxf.interceptor.LoggingOutInterceptor$LoggingCallback onClose<br />INFO: Outbound Message<br />---------------------------<br />ID: 1<br />Address: http://localhost:8080/cxf/camel-example/incident<br />Encoding: UTF-8<br />Content-Type: text/xml<br />Headers: {SOAPAction=["http://schemas.xmlsoap.org/ws/2005/02/rm/CreateSequence"], Connection=[Keep-Alive], Accept=[*/*]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br />  <soap:header><br />      <action xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2005/02/rm/CreateSequence</action><br />      <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:uuid:508b8914-1621-4992-ae2d-2249d417069a</messageid><br />      <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://localhost:8080/cxf/camel-example/incident</to><br />      <replyto xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          <address>http://localhost:9999/camel-example/incident</address><br />      </replyto><br />  </soap:header><br />  <soap:body><br />      <createsequence xmlns="http://schemas.xmlsoap.org/ws/2005/02/rm" ns2="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          <acksto><br />              <ns2:address>http://localhost:9999/camel-example/incident</ns2:address><br />          </acksto><br />          <expires>PT0S</expires><br />          <offer><br />              <identifier>urn:uuid:b12e4ccf-3bec-4f76-85f6-2b64f24745b5</identifier><br />              <expires>PT0S</expires><br />          </offer><br />      </createsequence><br />  </soap:body><br /></soap:envelope><br /><br />--------------------------------------<br />24-fÚvr.-2010 9:48:41 org.apache.cxf.interceptor.LoggingInInterceptor logging<br />INFO: Inbound Message<br />----------------------------<br />ID: 1<br />Response-Code: 202<br />Encoding: UTF-8<br />Content-Type: text/xml; charset=utf-8<br />Headers: {content-type=[text/xml; charset=utf-8], Content-Length=[532], Server=[Jetty(6.1.x)]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br />  <soap:header><br />      <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          urn:uuid:73d86df6-7d45-42df-8008-2a4ca48682fd<br />      </messageid><br />      <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</to><br />      <replyto xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          <address>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/none</address><br />      </replyto><br />  </soap:header><br />  <soap:body><br /></soap:body><br /><br />--------------------------------------<br />24-fÚvr.-2010 9:48:41 org.apache.cxf.interceptor.LoggingInInterceptor logging<br />INFO: Inbound Message<br />----------------------------<br />ID: 2<br />Address: /camel-example/incident<br />Response-Code: 200<br />Encoding: UTF-8<br />Content-Type: text/xml; charset=UTF-8<br />Headers: {content-type=[text/xml; charset=UTF-8], connection=[keep-alive], Host=[localhost:9999], Content-Length=[1006], User-Agent=[Progress FUSE Services Fram<br />ework 2.2.6-fuse-01-00], Content-Type=[text/xml; charset=UTF-8], Accept=[*/*], Pragma=[no-cache], Cache-Control=[no-cache]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br />  <soap:header><br />      <action xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2005/02/rm/CreateSequenceResponse</action><br />      <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />      urn:uuid:c8e59735-7738-40b2-98c1-28be15274b35<br />      </messageid><br />      <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://localhost:9999/camel-example/incident</to><br />      <relatesto xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:uuid:508b8914-1621-4992-ae2d-2249d417069a</relatesto><br />  </soap:header><br />  <soap:body><br />      <createsequenceresponse xmlns="http://schemas.xmlsoap.org/ws/2005/02/rm" ns2="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          <identifier>urn:uuid:b35dff50-43cb-43ad-9c9e-4b59f7cb55e7</identifier><br />          <expires>P0Y0M0DT0H0M0.0S</expires><br />          <accept><br />              <acksto><br />                  <ns2:address>http://localhost:8080/cxf/camel-example/incident</ns2:address><br />              </acksto><br />          </accept><br />      </createsequenceresponse><br />  </soap:body><br /></soap:envelope><br /><br />--------------------------------------<br />24-fÚvr.-2010 9:48:41 org.apache.cxf.ws.rm.soap.RMSoapInterceptor updateServiceModelInfo<br />INFO: Updating service model info in exchange<br />24-fÚvr.-2010 9:48:41 org.apache.cxf.interceptor.LoggingOutInterceptor$LoggingCallback onClose<br />INFO: Outbound Message<br />---------------------------<br />ID: 3<br />Address: http://localhost:8080/cxf/camel-example/incident<br />Encoding: UTF-8<br />Content-Type: text/xml<br />Headers: {SOAPAction=["http://reportincident.example.camel.apache.org/ReportIncident"], Connection=[Keep-Alive], Accept=[*/*]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br />  <soap:header><br />      <action xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://reportincident.example.camel.apache.org/ReportIncident</action><br />      <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:uuid:85a1ebac-5293-4daa-a656-987967aa2a4d</messageid><br />      <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://localhost:8080/cxf/camel-example/incident</to><br />      <replyto xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          <address>http://localhost:9999/camel-example/incident</address><br />      </replyto><br />      <wsrm:sequence ns2="http://schemas.xmlsoap.org/ws/2004/08/addressing" wsrm="http://schemas.xmlsoap.org/ws/2005/02/rm"><br />          <wsrm:identifier>urn:uuid:b35dff50-43cb-43ad-9c9e-4b59f7cb55e7</wsrm:identifier><br />              <wsrm:messagenumber>1</wsrm:messagenumber><br />      </wsrm:sequence><br />  </soap:header><br />  <soap:body><br />      <ns2:inputreportincident ns2="http://reportincident.example.camel.apache.org"><br />          <incidentid>0</incidentid><br />          <incidentdate>29-04-2009</incidentdate><br />          <givenname>moulliard</givenname><br />          <familyname>charles</familyname><br />          <summary><br />              This is a web service incident</summary><br />          <details>This is a web service incident - details</details><br />          <email>cmoulliard@gmail.com</email><br />          <phone><br />              +222 10 50 22<br />          </phone><br />      </ns2:inputreportincident><br />  </soap:body><br /></soap:envelope><br /><br />--------------------------------------<br />24-fÚvr.-2010 9:48:41 org.apache.cxf.interceptor.LoggingInInterceptor logging<br />INFO: Inbound Message<br />----------------------------<br />ID: 3<br />Response-Code: 202<br />Encoding: UTF-8<br />Content-Type: text/xml; charset=utf-8<br />Headers: {content-type=[text/xml; charset=utf-8], Content-Length=[532], Server=[Jetty(6.1.x)]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br />  <soap:header><br />      <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          urn:uuid:37dceb90-e1f5-4014-9749-8d4ae7eebb13</messageid><br />      <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</to><br />      <replyto xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          <address>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/none</address><br />      </replyto><br />  </soap:header><br />  <soap:body><br /></soap:body><br /><br />--------------------------------------<br />2010-02-24 09:48:41.937::INFO:  seeing JVM BUG(s) - cancelling interestOps==0<br />24-fÚvr.-2010 9:48:42 org.apache.cxf.interceptor.LoggingInInterceptor logging<br />INFO: Inbound Message<br />----------------------------<br />ID: 4<br />Address: /camel-example/incident<br />Response-Code: 200<br />Encoding: UTF-8<br />Content-Type: text/xml; charset=UTF-8<br />Headers: {content-type=[text/xml; charset=UTF-8], connection=[keep-alive], Host=[localhost:9999], Content-Length=[1057], User-Agent=[Progress FUSE Services Fram<br />ework 2.2.6-fuse-01-00], Content-Type=[text/xml; charset=UTF-8], Accept=[*/*], Pragma=[no-cache], Cache-Control=[no-cache]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br />  <soap:header><br />      <action xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://reportincident.example.camel.apache.org/ReportIncidentEndpoint/ReportIncidentResponse</action><br />      <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:uuid:6163b07e-c983-47f7-8699-c4670b61a213</messageid><br />      <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://localhost:9999/camel-example/incident</to><br />      <relatesto xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:uuid:85a1ebac-5293-4daa-a656-987967aa2a4d</relatesto><br />      <wsrm:sequence ns2="http://schemas.xmlsoap.org/ws/2004/08/addressing" wsrm="http://schemas.xmlsoap.org/ws/2005/02/rm"><br />          <wsrm:identifier>urn:uuid:b12e4ccf-3bec-4f76-85f6-2b64f24745b5</wsrm:identifier><br />          <wsrm:messagenumber>1</wsrm:messagenumber><br />      </wsrm:sequence><br />  </soap:header><br />  <soap:body><br />      <ns2:outputreportincident ns2="http://reportincident.example.camel.apache.org"><br />          <code>OK</code><br />      </ns2:outputreportincident><br />  </soap:body><br /></soap:envelope><br /><br />--------------------------------------<br /><br />>>>> Result - code : OK<br /><br />24-fÚvr.-2010 9:48:43 org.apache.cxf.interceptor.LoggingInInterceptor logging<br />INFO: Inbound Message<br />----------------------------<br />ID: 5<br />Address: /camel-example/incident<br />Response-Code: 200<br />Encoding: UTF-8<br />Content-Type: text/xml; charset=UTF-8<br />Headers: {content-type=[text/xml; charset=UTF-8], connection=[keep-alive], Host=[localhost:9999], Content-Length=[955], SOAPAction=["http://schemas.xmlsoap.org/<br />ws/2005/02/rm/SequenceAcknowledgement"], User-Agent=[Progress FUSE Services Framework 2.2.6-fuse-01-00], Content-Type=[text/xml; charset=UTF-8], Accept=[*/*], P<br />ragma=[no-cache], Cache-Control=[no-cache]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br />  <soap:header><br />      <action xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2005/02/rm/SequenceAcknowledgement<br />      </action><br />      <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:uuid:f57c0b96-fcc3-4543-bbc3-fd15a54622e7</messageid><br />      <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://localhost:9999/camel-example/incident</to><br />      <replyto xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          <address>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/none</address><br />      </replyto><br />      <wsrm:sequenceacknowledgement ns2="http://schemas.xmlsoap.org/ws/2004/08/addressing" wsrm="http://schemas.xmlsoap.org/ws/2005/02/rm"><br />          <wsrm:identifier>urn:uuid:b35dff50-43cb-43ad-9c9e-4b59f7cb55e7</wsrm:identifier><br />          <wsrm:acknowledgementrange lower="1" upper="1"><br />      </wsrm:acknowledgementrange><br />  </wsrm:sequenceacknowledgement><br />  <soap:body><br /></soap:body><br /><br /><br />--------------------------------------<br />24-fÚvr.-2010 9:48:43 org.apache.cxf.ws.rm.soap.RMSoapInterceptor updateServiceModelInfo<br />INFO: Updating service model info in exchange<br />24-fÚvr.-2010 9:48:44 org.apache.cxf.ws.rm.Proxy invoke<br />INFO: Sending out-of-band RM protocol message {http://schemas.xmlsoap.org/ws/2005/02/rm}SequenceAcknowledgement.<br />24-fÚvr.-2010 9:48:44 org.apache.cxf.interceptor.LoggingOutInterceptor$LoggingCallback onClose<br />INFO: Outbound Message<br />---------------------------<br />ID: 6<br />Address: http://localhost:8080/cxf/camel-example/incident<br />Encoding: UTF-8<br />Content-Type: text/xml<br />Headers: {SOAPAction=["http://schemas.xmlsoap.org/ws/2005/02/rm/SequenceAcknowledgement"], Connection=[Keep-Alive], Accept=[*/*]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br /><soap:header><br />  <action xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2005/02/rm/SequenceAcknowledgement</action><br />  <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">urn:uuid:c5584570-c10f-49cc-a3ef-c2c53363ec66</messageid><br />  <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://localhost:8080/cxf/camel-example/incident</to><br />  <replyto lns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />      <address>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/none</address><br />  </replyto><br />  <wsrm:sequenceacknowledgement ns2="http://schemas.xmlsoap.org/ws/2004/08/addressing" wsrm="http://schemas.xmlsoap.org/ws/2005/02/rm"><br />      <wsrm:identifier>urn:uuid:b12e4ccf-3bec-4f76-85f6-2b64f24745b5</wsrm:identifier><br />      <wsrm:acknowledgementrange lower="1" upper="1"><br />  </wsrm:acknowledgementrange><br /></wsrm:sequenceacknowledgement><br /><soap:body><br /></soap:body><br /><br />--------------------------------------<br />24-fÚvr.-2010 9:48:44 org.apache.cxf.interceptor.LoggingInInterceptor logging<br />INFO: Inbound Message<br />----------------------------<br />ID: 6<br />Response-Code: 202<br />Encoding: UTF-8<br />Content-Type: text/xml; charset=utf-8<br />Headers: {content-type=[text/xml; charset=utf-8], Content-Length=[532], Server=[Jetty(6.1.x)]}<br />Payload:<br /><br /><soap:envelope soap="http://schemas.xmlsoap.org/soap/envelope/"><br />  <soap:header><br />      <messageid xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          urn:uuid:786ad464-fb01-452a-9036-63c383955133</messageid><br />      <to xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing">http://schemas.xmlsoap.org/ws/2004/08/addressing/role/anonymous</to><br />      <replyto xmlns="http://schemas.xmlsoap.org/ws/2004/08/addressing"><br />          <address>http://schemas.xmlsoap.org/ws/2004/08/addressing/role/none</address><br />      </replyto><br />  </soap:header><br />  <soap:body><br /></soap:body><br /><br />--------------------------------------<br />24-fÚvr.-2010 9:49:12 org.apache.cxf.transport.http_jetty.JettyHTTPServerEngine shutdown<br /><br /><br /></soap:envelope></soap:header></soap:envelope></soap:header></soap:envelope></soap:envelope></soap:envelope></textarea><br /><br /><ul><li>Conclusion </li></ul><br />Awesome, isn'it. Even, if you continue to doubt about this specification, I'm pretty sure that in the future you will take it into account into your decision process regarding<br />to what has been developed here.</div>
