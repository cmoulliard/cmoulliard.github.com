---
layout: post
title: "Measure elapsed time with Camel"
date: 2011-02-23
comments: false
---

<div class='post'>
    With the last version of Apache Camel, we provide a
    <a href="http://svn.apache.org/viewvc/camel/trunk/camel-core/src/main/java/org/apache/camel/management/EventNotifierSupport.java?view=markup">event notifier support class</a> which allow to keep information about what happen on Exchange, Route and Endpoint. One of the benefit of this class is that you can easily audit messages created in Camel Routes, collect information and report that in log by example.<br/><br/>When developing an application, it is very important to calculate/measure elapsed time on the platform to find which part of your code, processor or system integrated which is the bad duck and must be improved.<br/><br/>In three steps, I would show you How to enable this mechanism to report :<br/>- Time elapsed to call an endpoint (could be another camel route, web service, ...)<br/>- Time elapsed on the route exchange<br/><br/>STEP 1 - Create a Class implementing the EventNotifierSupport<br/><br/>
    <pre name="code" class="java"><br/><br/>public class AuditEventNotifier extends EventNotifierSupport {<br/><br/>public void notify(EventObject event) throws Exception {<br/>  if (event instanceof ExchangeSentEvent) {<br/>      ExchangeSentEvent sent = (ExchangeSentEvent) event;<br/>      log.info(">>> Took " + sent.getTimeTaken() + " millis to send to external system : " + sent.getEndpoint());<br/>  }<br/><br/>  if (event instanceof ExchangeCompletedEvent) {;<br/>      ExchangeCompletedEvent exchangeCompletedEvent = (ExchangeCompletedEvent) event;<br/>      Exchange exchange = exchangeCompletedEvent.getExchange();<br/>      String routeId = exchange.getFromRouteId();<br/>      Date created = ((ExchangeCompletedEvent) event).getExchange().getProperty(Exchange.CREATED_TIMESTAMP, Date.class);<br/>      // calculate elapsed time<br/>      Date now = new Date();<br/>      long elapsed = now.getTime() - created.getTime();<br/>      log.info(">>> Took " + elapsed + " millis for the exchange on the route : " + routeId);<br/>  }<br/>}<br/><br/>public boolean isEnabled(EventObject event) {<br/>  return true;<br/>}<br/><br/>protected void doStart() throws Exception {<br/>  // filter out unwanted events<br/>  setIgnoreCamelContextEvents(true);<br/>  setIgnoreServiceEvents(true);<br/>  setIgnoreRouteEvents(true);<br/>  setIgnoreExchangeCreatedEvent(true);<br/>  setIgnoreExchangeCompletedEvent(false);<br/>  setIgnoreExchangeFailedEvents(true);<br/>  setIgnoreExchangeRedeliveryEvents(true);<br/>  setIgnoreExchangeSentEvents(false);<br/>}<br/><br/>protected void doStop() throws Exception {<br/>  // noop<br/>}<br/><br/>}<br/></pre>
    <br/><br/>Not really complicated and the code is explicit. Check the doStart() method to enable/disable the events for which you would like to gather information.<br/><br/>This example uses only Exchange.CREATED_TIMESTAMP property but the next version of Camel 2.7.0 will provide you the property exchange.RECEIVED_TIMESTAMP and so you will be able to calculate more easily the time spend by the exchange to call the different processors till it arrives at the end of the route.<br/><br/>This example collects Date information but you can imagine to use this mechanism to check if your route processes the message according to SLA, ....<br/><br/>STEP 2 - Instantiate the bean in Camel Spring XML<br/><br/>
    <pre name="code" class="xml"><br/>&lt;!-- Event Notifier --&gt;<br/>&lt;bean id="auditEventNotifier" class="com.sfr.audit.AuditEventNotifier"&gt;<br/>&lt;/bean&gt;<br/></pre>
    <br/>By adding this bean definition, Camel will automatically register it to the CamelContext created.<br/><br/>STEP 3 - Collect info into the log<br/>
    <pre name="code" class="html"><br/>18:10:46,060 | INFO  | tp1238469515-285 | AuditEventNotifier               | ?                                   ? | 68 - org.apache.camel.camel-core - 2.6.0.fuse-00-00 | >>> Took 3 millis for the exchange on the route : mock-HTTP-Server<br/>18:10:46,062 | INFO  | tp2056154542-293 | AuditEventNotifier               | ?                                   ? | 68 - org.apache.camel.camel-core - 2.6.0.fuse-00-00 | >>> Took 25 millis to send to external system : Endpoint[http://localhost:9191/sis]<br/>18:10:46,077 | INFO  | tp2056154542-293 | AuditEventNotifier               | ?                                   ? | 68 - org.apache.camel.camel-core - 2.6.0.fuse-00-00 | >>> Took 103 millis for the exchange on the route : ws-to-sis<br/></pre>
</div>
<h2>Comments</h2>
<div class='comments'>
    <div class='comment'>
        <div class='author'>cmoulliard</div>
        <div class='content'>
            Hi Antonin,<br/><br/>Can you open a JIRA ticket on camel web site (https://issues.apache.org/jira/browse/CAMEL) to allow us to solve this issue and provide it for next release of Camel ?<br/><br/>Regards,<br/><br/>Charles
        </div>
    </div>
    <div class='comment'>
        <div class='author'>Antonin Stefanutti</div>
        <div class='content'>
            I&#39;m trying to have the same mechanism working in a CDI container but the managed bean implementing EventNotifierSupport doesn&#39;t look registered in the Camel context by Camel CDI.<br/><br/>Would you have an insight on how to have this exemple working with Camel CDI?<br/><br/>Thanks a lot<br/>Antonin
        </div>
    </div>
    <div class='comment'>
        <div class='author'>Charles Moulliard</div>
        <div class='content'>
            This is really strange. Can you post your case to user mailing list of camel to allow us to take care of it (and if there is a bug to improve Camel) ?<br/><br/>Regards,<br/><br/>Charles
        </div>
    </div>
    <div class='comment'>
        <div class='author'>Gregor</div>
        <div class='content'>
            PS: I had to manually start() the custom EventNotifier, else it would just sit there and wait (and its log methods never called), although everything was configured correctly...</div>
    </div>
    <div class='comment'>
        <div class='author'>Gregor</div>
        <div class='content'>
            great post, just what I was looking for.<br/>Now if there only was an easy way to include a simple stopwatch I could use directly in my route DSL, like this:<br/><br/>(MyRouteBuilder.java)<br/>DateTime time;<br/>from(&quot;direct:foo&quot;)<br/>.routeIde(&quot;foo&quot;)<br/>.stopWatch(&quot;fooTimer&quot;).start(time)<br/>.process(...)<br/>.stopWatch(&quot;fooTimer&quot;).stop()<br/>.log(&quot;took &quot; + time.getTime() + &quot;s&quot;)<br/>.end();
        </div>
    </div>
    <div class='comment'>
        <div class='author'>Gregor</div>
        <div class='content'>
            great article, just what I was looking for.<br/>Couldn&#39;t this be made even more easy for the quick stopwatch-usecase to include something like this in the routebuilder DSL:<br/><br/>...<br/>.stopWatchStart()<br/>.process(...)<br/>.stopWatchEnd()<br/>...<br/>that outputs a simple timing information to the log?
        </div>
    </div>
</div>
